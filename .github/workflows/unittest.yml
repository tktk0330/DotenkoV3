name: Unit Tests

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  pull_request:
    branches: [ main, develop ]

# ä¸¦åˆ—å®Ÿè¡Œã®åˆ¶é™
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-14  # Xcode 15.4ä»¥é™ã‚’ã‚µãƒãƒ¼ãƒˆ
    
    strategy:
      matrix:
        # è¤‡æ•°ã®iOSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        destination: ['platform=iOS Simulator,name=iPhone 15,OS=17.5']
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    
    # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒ
    - name: Restore Secret Files
      env:
        CONFIG_BASE64: ${{ secrets.CONFIG_BASE64 }}
        GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}
        INFO_PLIST_BASE64: ${{ secrets.INFO_PLIST_BASE64 }}
      run: |
        # Config.swiftã®å¾©å…ƒ
        if [ -n "$CONFIG_BASE64" ]; then
          echo "$CONFIG_BASE64" | base64 --decode > DotenkoV3/Config/Config.swift
          echo "âœ… Config.swift restored from secrets"
        else
          echo "âš ï¸ CONFIG_BASE64 secret not found"
        fi
        
        # Info.plistã®å¾©å…ƒ
        if [ -n "$INFO_PLIST_BASE64" ]; then
          echo "$INFO_PLIST_BASE64" | base64 --decode > DotenkoV3/Info.plist
          echo "âœ… Info.plist restored from secrets"
        else
          echo "âš ï¸ INFO_PLIST_BASE64 secret not found, using existing file"
        fi
        
        # GoogleService-Info.plistã®å¾©å…ƒ
        if [ -n "$GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
          echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > DotenkoV3/GoogleService-Info.plist
          echo "âœ… GoogleService-Info.plist restored from secrets"
        else
          echo "âš ï¸ GOOGLE_SERVICE_INFO_PLIST_BASE64 secret not found"
          echo "â„¹ï¸ Firebaseè¨­å®šãŒå¿…è¦ãªå ´åˆã¯Secretsã«è¨­å®šã—ã¦ãã ã•ã„"
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        echo "ðŸ“ Secret files status:"
        ls -la DotenkoV3/Config/Config.swift DotenkoV3/Info.plist DotenkoV3/GoogleService-Info.plist 2>/dev/null || echo "Some files missing"
        echo "â„¹ï¸ AdMobè¨­å®šã¯Config.swiftã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™"
    
    # Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®š
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
    
    # CocoaPodsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
    
    # CocoaPodsã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install CocoaPods dependencies
      run: |
        gem install cocoapods
        pod install --repo-update
    
    # Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰è¨­å®šç¢ºèª
    - name: Show Xcode version and available simulators
      run: |
        xcodebuild -version
        xcrun simctl list devicetypes
        xcrun simctl list runtimes
    
    # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -workspace DotenkoV3.xcworkspace \
          -scheme DotenkoV3 \
          -destination '${{ matrix.destination }}' \
          -configuration Debug \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    # ãƒ†ã‚¹ãƒˆçµæžœã®è§£æžã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate Test Report
      if: always()  # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
      run: |
        if [ -d "TestResults.xcresult" ]; then
          xcrun xcresulttool get --format json --path TestResults.xcresult > test_results.json
          echo "Test results generated"
        else
          echo "No test results found"
        fi
    
    # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç”Ÿæˆ
    - name: Generate Code Coverage
      if: always()
      run: |
        if [ -d "DerivedData" ]; then
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json || true
          echo "Code coverage generated"
        else
          echo "No coverage data found"
        fi
    
    # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: Cleanup Secret Files
      if: always()
      run: |
        rm -f DotenkoV3/Config/Config.swift DotenkoV3/Info.plist DotenkoV3/GoogleService-Info.plist
        echo "ðŸ§¹ Secret files cleaned up"
    
    # ãƒ†ã‚¹ãƒˆçµæžœã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.destination }}
        path: |
          TestResults.xcresult
          test_results.json
          coverage.json
        retention-days: 30
    
    # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ›
    - name: Show Test Failures
      if: failure()
      run: |
        if [ -d "TestResults.xcresult" ]; then
          xcrun xcresulttool get --format json --path TestResults.xcresult | jq '.issues.testFailureSummaries'
        fi

  # ãƒ†ã‚¹ãƒˆçµæžœã®ã‚µãƒžãƒªãƒ¼ä½œæˆ
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Test Status: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some tests failed. Check the test job for details." >> $GITHUB_STEP_SUMMARY
        fi
