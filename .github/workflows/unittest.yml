name: Unit Tests

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  pull_request:
    branches: [ main, develop ]

# ä¸¦åˆ—å®Ÿè¡Œã®åˆ¶é™
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-15  # Xcode 16ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚macos-15ã«å¤‰æ›´
    
    strategy:
      matrix:
        # åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆiOS 18.2ã§ãƒ†ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ä¸€è‡´ï¼‰
        destination: [
          'platform=iOS Simulator,name=iPhone 16,OS=18.2'
        ]
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    
    # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒ
    - name: Restore Secret Files
      env:
        CONFIG_BASE64: ${{ secrets.CONFIG_BASE64 }}
        GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}
        INFO_PLIST_BASE64: ${{ secrets.INFO_PLIST_BASE64 }}
      run: |
        # Config.swiftã®å¾©å…ƒ
        # Config.swiftã®å¾©å…ƒ
        if [ -n "$CONFIG_BASE64" ]; then
          if echo "$CONFIG_BASE64" | base64 --decode > DotenkoV3/Config/Config.swift; then
            echo "âœ… Config.swift restored from secrets"
          else
            echo "âŒ Failed to decode CONFIG_BASE64 secret"
            exit 1
          fi
        else
          echo "âš ï¸ CONFIG_BASE64 secret not found"
        fi
        
        # Info.plistã®å¾©å…ƒ
        if [ -n "$INFO_PLIST_BASE64" ]; then
          echo "$INFO_PLIST_BASE64" | base64 --decode > DotenkoV3/Info.plist
          echo "âœ… Info.plist restored from secrets"
        else
          echo "âš ï¸ INFO_PLIST_BASE64 secret not found, using existing file"
        fi
        
        # GoogleService-Info.plistã®å¾©å…ƒ
        if [ -n "$GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
          echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > DotenkoV3/GoogleService-Info.plist
          echo "âœ… GoogleService-Info.plist restored from secrets"
        else
          echo "âš ï¸ GOOGLE_SERVICE_INFO_PLIST_BASE64 secret not found"
          echo "â„¹ï¸ Firebaseè¨­å®šãŒå¿…è¦ãªå ´åˆã¯Secretsã«è¨­å®šã—ã¦ãã ã•ã„"
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        echo "ğŸ“ Secret files status:"
        ls -la DotenkoV3/Config/Config.swift DotenkoV3/Info.plist DotenkoV3/GoogleService-Info.plist 2>/dev/null || echo "Some files missing"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ç°¡æ˜“æ¤œè¨¼
        echo ""
        echo "ğŸ” File content validation:"
        if [ -f "DotenkoV3/Config/Config.swift" ]; then
          echo "âœ… Config.swift: $(wc -l < DotenkoV3/Config/Config.swift) lines, $(wc -c < DotenkoV3/Config/Config.swift) bytes"
          echo "   First line: $(head -1 DotenkoV3/Config/Config.swift)"
        fi
        
        if [ -f "DotenkoV3/Info.plist" ]; then
          echo "âœ… Info.plist: $(wc -c < DotenkoV3/Info.plist) bytes"
          echo "   Contains <?xml: $(grep -c '<?xml' DotenkoV3/Info.plist || echo 0)"
        fi
        
        if [ -f "DotenkoV3/GoogleService-Info.plist" ]; then
          echo "âœ… GoogleService-Info.plist: $(wc -c < DotenkoV3/GoogleService-Info.plist) bytes"
          echo "   Contains <?xml: $(grep -c '<?xml' DotenkoV3/GoogleService-Info.plist || echo 0)"
        fi
        
        echo "â„¹ï¸ AdMobè¨­å®šã¯Config.swiftã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™"
    
    # Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®š
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼77ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´
    
    # CocoaPodsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
    
    # CocoaPodsã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install CocoaPods dependencies
      run: |
        gem install cocoapods
        pod install --repo-update
    
    # Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰è¨­å®šç¢ºèª
    - name: Show Xcode version and available simulators
      run: |
        xcodebuild -version
        xcrun simctl list devicetypes
        xcrun simctl list runtimes
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®ç¢ºèª
    - name: Verify Project Configuration
      run: |
        echo "ğŸ“‹ Checking project configuration..."
        xcodebuild -list -workspace DotenkoV3.xcworkspace
        echo ""
        echo "ğŸ“ Checking secret files..."
        ls -la DotenkoV3/Config/
        echo ""
        echo "ğŸ” Checking Config.swift content (first 10 lines)..."
        head -10 DotenkoV3/Config/Config.swift || echo "Config.swift not found or empty"
    
    # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
    - name: Run Unit Tests
      run: |
        echo "ğŸš€ Starting Unit Tests..."
        echo "ğŸ“± Testing on: ${{ matrix.destination }}"
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if xcodebuild test \
          -workspace DotenkoV3.xcworkspace \
          -scheme DotenkoV3 \
          -destination '${{ matrix.destination }}' \
          -configuration Debug \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO; then
          echo "âœ… Unit tests completed successfully"
        else
          echo "âŒ Unit tests failed"
          # ãƒ†ã‚¹ãƒˆçµæœãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -d "TestResults.xcresult" ]; then
            echo "ğŸ“Š Test results bundle was created despite failures"
          else
            echo "âš ï¸ No test results bundle found"
          fi
          exit 1
        fi
    
    # ãƒ†ã‚¹ãƒˆçµæœã®è§£æã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate Test Report
      if: always()  # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
      run: |
        if [ -d "TestResults.xcresult" ]; then
          echo "ğŸ” Generating test report..."
          # æ–°ã—ã„æ¨å¥¨æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆçµæœã‚’å–å¾—
          if xcrun xcresulttool get test-results summary --path TestResults.xcresult --format json > test_results.json 2>/dev/null; then
            echo "âœ… Test results generated using new format"
          else
            echo "âš ï¸ New format failed, trying legacy format..."
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã§å–å¾—
            if xcrun xcresulttool get --legacy --format json --path TestResults.xcresult > test_results.json 2>/dev/null; then
              echo "âœ… Test results generated using legacy format"
            else
              echo "âŒ Failed to generate test results"
              # æœ€ä½é™ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
              echo '{"status": "error", "message": "Failed to parse test results"}' > test_results.json
            fi
          fi
        else
          echo "âŒ No test results found"
          echo '{"status": "error", "message": "No test results found"}' > test_results.json
        fi
    
    # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç”Ÿæˆ
    - name: Generate Code Coverage
      if: always()
      run: |
        if [ -d "DerivedData" ]; then
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json || true
          echo "Code coverage generated"
        else
          echo "No coverage data found"
        fi
    
    # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: Cleanup Secret Files
      if: always()
      run: |
        rm -f DotenkoV3/Config/Config.swift DotenkoV3/Info.plist DotenkoV3/GoogleService-Info.plist
        echo "ğŸ§¹ Secret files cleaned up"
    
    # ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ strategy.job-index }}
        path: |
          TestResults.xcresult
          test_results.json
          coverage.json
        retention-days: 30
    
    # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ›
    - name: Show Test Failures
      if: failure()
      run: |
        if [ -d "TestResults.xcresult" ]; then
          echo "ğŸ” Analyzing test failures..."
          # æ–°ã—ã„æ¨å¥¨æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆå¤±æ•—æƒ…å ±ã‚’å–å¾—
          if xcrun xcresulttool get test-results tests --path TestResults.xcresult --format json > test_failures.json 2>/dev/null; then
            echo "âœ… Test failure analysis using new format"
            # ãƒ†ã‚¹ãƒˆå¤±æ•—ã®è©³ç´°ã‚’è¡¨ç¤º
            if command -v jq >/dev/null 2>&1; then
              echo "ğŸ“Š Test failure summary:"
              jq '.tests[] | select(.status == "failed") | {name: .name, status: .status}' test_failures.json || echo "No specific failures found"
            else
              echo "ğŸ“„ Raw test failure data:"
              head -20 test_failures.json
            fi
          else
            echo "âš ï¸ New format failed, trying legacy format..."
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã§å–å¾—
            if xcrun xcresulttool get --legacy --format json --path TestResults.xcresult > legacy_results.json 2>/dev/null; then
              echo "âœ… Test failure analysis using legacy format"
              if command -v jq >/dev/null 2>&1; then
                echo "ğŸ“Š Legacy format failure summary:"
                jq '.issues.testFailureSummaries' legacy_results.json 2>/dev/null || echo "No failure summaries found"
              else
                echo "ğŸ“„ Raw legacy failure data:"
                head -20 legacy_results.json
              fi
            else
              echo "âŒ Failed to analyze test failures"
            fi
          fi
        else
          echo "âŒ No test results found for failure analysis"
        fi

  # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ä½œæˆ
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        {
          echo "## Test Results Summary"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Test Status: ${{ needs.test.result }}"
          echo ""
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… All tests passed successfully!"
          else
            echo "âŒ Some tests failed. Check the test job for details."
          fi
        } >> "$GITHUB_STEP_SUMMARY"
