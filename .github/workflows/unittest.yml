name: Unit Tests

# ğŸš€ GitHub Actionsã®åŸºæœ¬è¨­å®š
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã„ã¤å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚’å®šç¾©
on:
  pull_request:
    branches: [ main, develop ]  # main ã¾ãŸã¯ develop ãƒ–ãƒ©ãƒ³ãƒã¸ã®Pull Requestæ™‚ã«å®Ÿè¡Œ

# ğŸ”„ ä¸¦åˆ—å®Ÿè¡Œã®åˆ¶é™è¨­å®š
# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒåŒæ™‚å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«åˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã¨ãƒ–ãƒ©ãƒ³ãƒåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  cancel-in-progress: true  # æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰ã€å®Ÿè¡Œä¸­ã®ã‚‚ã®ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

jobs:
  test:
    name: Run Unit Tests  # ã‚¸ãƒ§ãƒ–ã®è¡¨ç¤ºå
    runs-on: macos-15  # ğŸ–¥ï¸ macOS 15 (Xcode 16ã‚’ã‚µãƒãƒ¼ãƒˆ)
    
    # ğŸ“± ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒã®è¨­å®š
    # è¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ãƒ»OSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã«ä½¿ç”¨
    strategy:
      matrix:
        # ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼è¨­å®š
        destination: [
          'platform=iOS Simulator,name=iPhone 16,OS=18.2'  # iPhone 16, iOS 18.2
        ]
    
    steps:
    # ğŸ“¥ Step 1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    - name: Checkout code
      uses: actions/checkout@v4  # GitHubãŒæä¾›ã™ã‚‹å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆé€šå¸¸ã¯æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã®ã¿ã§OKï¼‰
    
    # ğŸ” Step 2: æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒ
    # GitHubã®Secretsã«ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’BASE64ã‹ã‚‰å¾©å…ƒ
    - name: Restore Secret Files
      env:
        # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ©Ÿå¯†æƒ…å ±ã‚’è¨­å®š
        CONFIG_BASE64: ${{ secrets.CONFIG_BASE64 }}  # ã‚¢ãƒ—ãƒªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
        GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}  # Firebaseè¨­å®š
        INFO_PLIST_BASE64: ${{ secrets.INFO_PLIST_BASE64 }}  # ã‚¢ãƒ—ãƒªæƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«
      run: |
        # Config.swiftã®å¾©å…ƒ
        # Config.swiftã®å¾©å…ƒ
        if [ -n "$CONFIG_BASE64" ]; then
          if echo "$CONFIG_BASE64" | base64 --decode > DotenkoV3/Config/Config.swift; then
            echo "âœ… Config.swift restored from secrets"
          else
            echo "âŒ Failed to decode CONFIG_BASE64 secret"
            exit 1
          fi
        else
          echo "âš ï¸ CONFIG_BASE64 secret not found"
        fi
        
        # Info.plistã®å¾©å…ƒ
        if [ -n "$INFO_PLIST_BASE64" ]; then
          echo "$INFO_PLIST_BASE64" | base64 --decode > DotenkoV3/Info.plist
          echo "âœ… Info.plist restored from secrets"
        else
          echo "âš ï¸ INFO_PLIST_BASE64 secret not found, using existing file"
        fi
        
        # GoogleService-Info.plistã®å¾©å…ƒ
        if [ -n "$GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
          echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > DotenkoV3/GoogleService-Info.plist
          echo "âœ… GoogleService-Info.plist restored from secrets"
        else
          echo "âš ï¸ GOOGLE_SERVICE_INFO_PLIST_BASE64 secret not found"
          echo "â„¹ï¸ Firebaseè¨­å®šãŒå¿…è¦ãªå ´åˆã¯Secretsã«è¨­å®šã—ã¦ãã ã•ã„"
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        echo "ğŸ“ Secret files status:"
        ls -la DotenkoV3/Config/Config.swift DotenkoV3/Info.plist DotenkoV3/GoogleService-Info.plist 2>/dev/null || echo "Some files missing"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ç°¡æ˜“æ¤œè¨¼
        echo ""
        echo "ğŸ” File content validation:"
        if [ -f "DotenkoV3/Config/Config.swift" ]; then
          echo "âœ… Config.swift: $(wc -l < DotenkoV3/Config/Config.swift) lines, $(wc -c < DotenkoV3/Config/Config.swift) bytes"
          echo "   First line: $(head -1 DotenkoV3/Config/Config.swift)"
        fi
        
        if [ -f "DotenkoV3/Info.plist" ]; then
          echo "âœ… Info.plist: $(wc -c < DotenkoV3/Info.plist) bytes"
          echo "   Contains <?xml: $(grep -c '<?xml' DotenkoV3/Info.plist || echo 0)"
        fi
        
        if [ -f "DotenkoV3/GoogleService-Info.plist" ]; then
          echo "âœ… GoogleService-Info.plist: $(wc -c < DotenkoV3/GoogleService-Info.plist) bytes"
          echo "   Contains <?xml: $(grep -c '<?xml' DotenkoV3/GoogleService-Info.plist || echo 0)"
        fi
        
        echo "â„¹ï¸ AdMobè¨­å®šã¯Config.swiftã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™"
    
    # ğŸ”§ Step 3: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®š
    # ç‰¹å®šã®Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ä½¿ç”¨
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1  # Xcodeè¨­å®šç”¨ã®å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      with:
        xcode-version: '16.2'  # Xcode 16.2ã‚’ä½¿ç”¨ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼77ã‚’ã‚µãƒãƒ¼ãƒˆï¼‰
    
    # ğŸ—„ï¸ Step 4: CocoaPodsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    # ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
    - name: Cache CocoaPods
      uses: actions/cache@v4  # GitHubãŒæä¾›ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      with:
        path: Pods  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚­ãƒ¼
        restore-keys: |
          ${{ runner.os }}-pods-  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ä»£æ›¿ã‚­ãƒ¼
    
    # ğŸ“¦ Step 5: CocoaPodsã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    # iOSã‚¢ãƒ—ãƒªã®å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGoogle Mobile Ads SDKãªã©ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install CocoaPods dependencies
      run: |
        gem install cocoapods  # CocoaPodsãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pod install --repo-update  # Podfileã«è¨˜è¼‰ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    
    # Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰è¨­å®šç¢ºèª
    - name: Show Xcode version and available simulators
      run: |
        xcodebuild -version
        xcrun simctl list devicetypes
        xcrun simctl list runtimes
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®ç¢ºèª
    - name: Verify Project Configuration
      run: |
        echo "ğŸ“‹ Checking project configuration..."
        xcodebuild -list -workspace DotenkoV3.xcworkspace
        echo ""
        echo "ğŸ“ Checking secret files..."
        ls -la DotenkoV3/Config/
        echo ""
        echo "ğŸ” Checking Config.swift content (first 10 lines)..."
        head -10 DotenkoV3/Config/Config.swift || echo "Config.swift not found or empty"
    
    # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
    - name: Run Unit Tests
      run: |
        echo "ğŸš€ Starting Unit Tests..."
        echo "ğŸ“± Testing on: ${{ matrix.destination }}"
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if xcodebuild test \
          -workspace DotenkoV3.xcworkspace \
          -scheme DotenkoV3 \
          -destination '${{ matrix.destination }}' \
          -configuration Debug \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO; then
          echo "âœ… Unit tests completed successfully"
        else
          echo "âŒ Unit tests failed"
          # ãƒ†ã‚¹ãƒˆçµæœãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -d "TestResults.xcresult" ]; then
            echo "ğŸ“Š Test results bundle was created despite failures"
          else
            echo "âš ï¸ No test results bundle found"
          fi
          exit 1
        fi
    
    # ğŸ“Š Step 8: ãƒ†ã‚¹ãƒˆçµæœã®è§£æã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    # ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
    - name: Generate Test Report
      if: always()  # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
      run: |
        if [ -d "TestResults.xcresult" ]; then
          echo "ğŸ” Generating test report..."
          # æ–°ã—ã„æ¨å¥¨æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆçµæœã‚’å–å¾—
          if xcrun xcresulttool get test-results summary --path TestResults.xcresult --format json > test_results.json 2>/dev/null; then
            echo "âœ… Test results generated using new format"
          else
            echo "âš ï¸ New format failed, trying legacy format..."
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã§å–å¾—
            if xcrun xcresulttool get --legacy --format json --path TestResults.xcresult > test_results.json 2>/dev/null; then
              echo "âœ… Test results generated using legacy format"
            else
              echo "âŒ Failed to generate test results"
              # æœ€ä½é™ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
              echo '{"status": "error", "message": "Failed to parse test results"}' > test_results.json
            fi
          fi
        else
          echo "âŒ No test results found"
          echo '{"status": "error", "message": "No test results found"}' > test_results.json
        fi
    
    # ğŸ¯ Step 9: ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
    # ç‹¬è‡ªå½¢å¼ã§ãƒ†ã‚¹ãƒˆçµæœã‚’è¦‹ã‚„ã™ãè¡¨ç¤º
    - name: Generate Custom Test Report
      if: always()
      run: |
        echo "ğŸ“‹ ===== DOTENKO V3 TEST REPORT ====="
        echo "ğŸ• Test Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“± Device: iPhone 16 (iOS 18.2)"
        echo "ğŸ”§ Xcode: 16.2"
        echo ""
        
        # ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°è§£æ
        if [ -d "TestResults.xcresult" ]; then
          # æ–°ã—ã„å½¢å¼ã§ãƒ†ã‚¹ãƒˆè©³ç´°ã‚’å–å¾—
          if xcrun xcresulttool get test-results tests --path TestResults.xcresult --format json > detailed_tests.json 2>/dev/null; then
            echo "ğŸ§ª TEST RESULTS SUMMARY:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # jqãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if command -v jq >/dev/null 2>&1; then
              # ãƒ†ã‚¹ãƒˆç·æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
              total_tests=$(jq '.tests | length' detailed_tests.json 2>/dev/null || echo "0")
              passed_tests=$(jq '[.tests[] | select(.status == "passed")] | length' detailed_tests.json 2>/dev/null || echo "0")
              failed_tests=$(jq '[.tests[] | select(.status == "failed")] | length' detailed_tests.json 2>/dev/null || echo "0")
              skipped_tests=$(jq '[.tests[] | select(.status == "skipped")] | length' detailed_tests.json 2>/dev/null || echo "0")
              
              echo "ğŸ“Š Total Tests: $total_tests"
              echo "âœ… Passed: $passed_tests"
              echo "âŒ Failed: $failed_tests"
              echo "â­ï¸ Skipped: $skipped_tests"
              echo ""
              
              # å„ãƒ†ã‚¹ãƒˆã®è©³ç´°ã‚’è¡¨ç¤º
              echo "ğŸ“ INDIVIDUAL TEST RESULTS:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              jq -r '.tests[] | 
                if .status == "passed" then
                  "âœ… PASS | " + .name
                elif .status == "failed" then
                  "âŒ FAIL | " + .name
                elif .status == "skipped" then
                  "â­ï¸ SKIP | " + .name
                else
                  "â“ " + .status + " | " + .name
                end' detailed_tests.json 2>/dev/null || echo "Unable to parse individual test results"
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # æˆåŠŸç‡ã‚’è¨ˆç®—ï¼ˆbcã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã‚ãªã„æ–¹æ³•ï¼‰
              if [ "$total_tests" -gt 0 ]; then
                success_rate=$(awk "BEGIN {printf \"%.1f\", $passed_tests * 100 / $total_tests}" 2>/dev/null || echo "N/A")
                echo "ğŸ¯ Success Rate: $success_rate%"
              else
                echo "ğŸ¯ Success Rate: N/A"
              fi
              
            else
              echo "âš ï¸ jq not available, showing raw test count"
              echo "ğŸ“Š Test results file generated successfully"
            fi
          else
            echo "âš ï¸ Could not parse test results in detail"
          fi
        else
          echo "âŒ No test results bundle found"
        fi
        
        echo ""
        echo "ğŸ End of Test Report"
        echo "======================================"
    
    # ğŸ“ˆ Step 10: ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç”Ÿæˆ
    # ãƒ†ã‚¹ãƒˆãŒã©ã®ç¨‹åº¦ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ã‹ã‚’æ¸¬å®š
    - name: Generate Code Coverage
      if: always()
      run: |
        if [ -d "DerivedData" ]; then
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json || true
          echo "Code coverage generated"
        else
          echo "No coverage data found"
        fi
    
    # ğŸ§¹ Step 11: æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    - name: Cleanup Secret Files
      if: always()  # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
      run: |
        rm -f DotenkoV3/Config/Config.swift DotenkoV3/Info.plist DotenkoV3/GoogleService-Info.plist
        echo "ğŸ§¹ Secret files cleaned up"
    
    # ğŸ“¤ Step 12: ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
    # ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHub Actionsã«ä¿å­˜ï¼ˆå¾Œã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ï¼‰
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      with:
        name: test-results-${{ strategy.job-index }}  # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®åå‰
        path: |
          TestResults.xcresult  # Xcodeã®ãƒ†ã‚¹ãƒˆçµæœãƒãƒ³ãƒ‰ãƒ«
          test_results.json     # JSONå½¢å¼ã®ãƒ†ã‚¹ãƒˆçµæœ
          detailed_tests.json   # è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœ
          coverage.json         # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±
        retention-days: 30  # 30æ—¥é–“ä¿å­˜
    
    # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ›
    - name: Show Test Failures
      if: failure()
      run: |
        if [ -d "TestResults.xcresult" ]; then
          echo "ğŸ” Analyzing test failures..."
          # æ–°ã—ã„æ¨å¥¨æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆå¤±æ•—æƒ…å ±ã‚’å–å¾—
          if xcrun xcresulttool get test-results tests --path TestResults.xcresult --format json > test_failures.json 2>/dev/null; then
            echo "âœ… Test failure analysis using new format"
            # ãƒ†ã‚¹ãƒˆå¤±æ•—ã®è©³ç´°ã‚’è¡¨ç¤º
            if command -v jq >/dev/null 2>&1; then
              echo "ğŸ“Š Test failure summary:"
              jq '.tests[] | select(.status == "failed") | {name: .name, status: .status}' test_failures.json || echo "No specific failures found"
            else
              echo "ğŸ“„ Raw test failure data:"
              head -20 test_failures.json
            fi
          else
            echo "âš ï¸ New format failed, trying legacy format..."
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã§å–å¾—
            if xcrun xcresulttool get --legacy --format json --path TestResults.xcresult > legacy_results.json 2>/dev/null; then
              echo "âœ… Test failure analysis using legacy format"
              if command -v jq >/dev/null 2>&1; then
                echo "ğŸ“Š Legacy format failure summary:"
                jq '.issues.testFailureSummaries' legacy_results.json 2>/dev/null || echo "No failure summaries found"
              else
                echo "ğŸ“„ Raw legacy failure data:"
                head -20 legacy_results.json
              fi
            else
              echo "âŒ Failed to analyze test failures"
            fi
          fi
        else
          echo "âŒ No test results found for failure analysis"
        fi

  # ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ä½œæˆ
  # ãƒ¡ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–å®Œäº†å¾Œã«ã€çµæœã‚’ã¾ã¨ã‚ã¦è¡¨ç¤º
  test-summary:
    name: Test Summary  # ã‚µãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ–ã®è¡¨ç¤ºå
    runs-on: ubuntu-latest  # è»½é‡ãªUbuntuãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨
    needs: test  # testã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    if: always()  # testã‚¸ãƒ§ãƒ–ãŒæˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
    
    steps:
    # ğŸ“Š GitHub Actions Summary ã«ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤º
    - name: Test Summary
      run: |
        {
          echo "# ğŸ§ª DOTENKO V3 Test Results"
          echo ""
          echo "## ğŸ“Š Summary Information"
          echo "- **Branch**: ${{ github.ref_name }}"
          echo "- **Commit**: ${{ github.sha }}"
          echo "- **Test Status**: ${{ needs.test.result }}"
          echo "- **Test Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "## âœ… Test Result: SUCCESS"
            echo ""
            echo "ğŸ‰ All tests passed successfully!"
            echo ""
            echo "### What this means:"
            echo "- âœ… All unit tests are working correctly"
            echo "- âœ… NavigationManager functionality is verified"
            echo "- âœ… App components are properly tested"
            echo "- âœ… Code is ready for deployment"
          else
            echo "## âŒ Test Result: FAILURE"
            echo ""
            echo "âš ï¸ Some tests failed. Please check the test job for details."
            echo ""
            echo "### Next steps:"
            echo "- ğŸ” Review the test failure details above"
            echo "- ğŸ› ï¸ Fix the failing tests"
            echo "- ğŸ”„ Push the fixes to trigger a new test run"
          fi
          echo ""
          echo "---"
          echo "*Generated by GitHub Actions*"
        } >> "$GITHUB_STEP_SUMMARY"
